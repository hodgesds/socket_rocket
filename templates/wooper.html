<!DOCTYPE html>
<meta charset="utf-8">
<head>
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  padding-top: 40px;
  position: relative;
  width: 960px;
}

line {
    stroke: 'black';
    stroke-width: 1px;
}

dots{
   stroke: {{color}};
}


</style>

<script src="static/jquery-1.10.1.min.js"></script>
</head>
<body>

<script src="static/d3.v3.min.js"></script>
<script>


//////////////////////////////////
// sockets
//////////////////////////////////
var wsUri = "ws://localhost:8000/echo"; 
var name = '{{name}}';
var output;  
var channel = '{{channel}}';


function socketSetup(){
   websocket = new WebSocket(wsUri); 
   websocket.onopen = function(evt) { 
       onOpen(evt);
   }; 
   websocket.onclose = function(evt) { 
       onClose(evt); 
   }; 
   websocket.onmessage = function(evt) { 
     onMessage(evt) ;
   }; 
   websocket.onerror = function(evt) { 
     onError(evt) ;
   }; 
}
   function onOpen(evt) { 
        doSend(name + " has connected!"); 
        // subscribe to the channel
        websocket.send('{"subscribe":"' + channel + '"}');
   }  
   function onClose(evt) { 
        writeToScreen(name + " has disconnected!"); 
   }  
   function onMessage(evt) { 
       aa=evt;
        console.log('Got message:'+ evt.data);
        ceeLow(evt.data);
       // websocket.close(); 
   }  
   function onError(evt) { 
        console.log("ERROR!", evt.data); 
   }  
   function doSend(message) { 
       //console.log( message);  
       websocket.send(message);
   }
   
   function writeToScreen(message) {
       //console.log(message);
   }


socketSetup();
// D3 setup stuff

var line;
var dots;
var w = 900;
var h = 400;
var border=1;
var count = 0;
var clist = [];
var others = {}
var maxobs = 100;

randomColor = function() {
    return "hsl(" + Math.random() * 360 + ",100%,50%)";
    }

var myColor = randomColor();

var cvis = d3.select("body").append("svg")
     .attr("width", w)
     .attr("height", h)
     .attr("border",border)
     .on("mousemove", cmove);

var cvis2 = d3.select("body").append("svg")
     .attr("width", w)
     .attr("height", h)
     .attr("border",border)
     .on("mousemove", cmove);


function ceeLow(message){
    message = JSON.parse(message);
    data = JSON.parse(message.data);
    console.log(data);
    if (Object.keys(others).indexOf(data.name)===-1){
        others[data.name] = {
            clist : [],
            pos: [data.xcord, data.ycord],
            color: data.color,
            count:0,
        }
    }

    var enter = cvis2.selectAll("circle")
    .data(others[data.name].clist)
    .enter()
    .append("circle")
    .style("fill", others[data.name].color)
    .attr("cx", others[data.name].pos[0])
    .attr("cy", others[data.name].pos[1])
    .attr("r", 20);


    cvis2.select("text").remove(); //get rid of old lables

    var who = cvis2.selectAll("text")
    .data([data.name])
    .enter()
    .append("text")
    .text(data.name)
    .attr("dx", others[data.name].pos[0])
    .attr("dy", others[data.name].pos[1])
    .attr("font-family", "sans-serif")
    .attr("font-size", "20px")
    .attr("fill", "black");
 
    others[data.name].count += 1;
    others[data.name].clist.push(others[data.name].count);
    if (others[data.name].clist > maxobs){
       others[data.name].clist.shift();
       cvis2.select("circle")
       .remove();
    }    

}

function cmove(){
    var pos = d3.mouse(this);
    var enter = cvis.selectAll("circle")
    .data(clist)
    .enter()
    .append("circle")
    .style("fill", myColor)
    .attr("cx", pos[0])
    .attr("cy", pos[1])
    .attr("r", 20);


    cvis.select("text").remove(); //get rid of old lables

    var who = cvis.selectAll("text")
    .data([name])
    .enter()
    .append("text")
    .text(name)
    .attr("dx", pos[0])
    .attr("dy", pos[1])
    .attr("font-family", "sans-serif")
    .attr("font-size", "20px")
    .attr("fill", "black");
 
    var socketMessage = '{"name":"' + name + '","xcord":"' + pos[0] + 
        '","ycord":"' + pos[1] + '","channel":"' + channel +
        '","color":"' + myColor + '"}';
    //console.log(socketMessage);
    websocket.send(socketMessage);
    count += 1;
    clist.push(count);
    if (clist.length > maxobs){
       clist.shift();
       cvis.select("circle")
       .remove();
    }    
}



 var cborderPath = cvis.append("rect")
  .attr("x", 0)
  .attr("y", 0)
  .attr("height", h)
  .attr("width", w)
  .style("stroke", "red")
  .style("fill", "none")
  .style("stroke-width", 1);

 var cborderPath2 = cvis2.append("rect")
  .attr("x", 0)
  .attr("y", 0)
  .attr("height", h)
  .attr("width", w)
  .style("stroke", "red")
  .style("fill", "none")
  .style("stroke-width", 1);

</script>

</body>
</html>
